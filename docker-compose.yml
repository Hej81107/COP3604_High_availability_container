version: '3.8'

services:
  postgres:
    image: postgres:13
    environment:
      POSTGRES_USER: gitea
      POSTGRES_PASSWORD: gitea_pass
      POSTGRES_DB: gitea
    volumes:
      - gitea_data:/var/lib/postgresql/data
    networks:
      - gitea_network
    ports:
      - "5432:5432"
    deploy:
      replicas: 1

  gitea:
    image: gitea/gitea:latest
    init: true
   # user: "1007"
    environment:
      DB_TYPE: postgres
      DB_HOST: postgres
      DB_NAME: gitea
      DB_USER: gitea
      DB_PASSWD: gitea_pass
      #ROOT_URL: "http://localhost:85"
    volumes:
      - gitea_config:/data
    networks:
      - gitea_network
    ports:
      - "3000"
    expose:
      - "3000"
    deploy:
      replicas: 3
      labels:
       - "swarm.autoscale=true"
       - "swarm.autoscale.min = 3"
       - "swarm.autoscale.max = 6"
       - "swarm.autoscale.percentage-max=1"
      # - "swarm.autoscale.percentage-min=1"
      resources:
        limits:
          cpus: '1.0'
       # - "traefik.enable=true"
       #- "traefik.http.routers.gitea.rule=PathPrefix(`/`)"
       # - "traefik.http.routers.gitea.rule=Host('localhost')"
       # - "traefik.http.routers.gitea.entrypoints=web"
       # - "traefik.http.services.gitea.loadbalancer.server.port=3000"
       # - "traefik.http.middlewares.gitea-stripprefix.stripprefix.prefixes=/git"
       # - "traefik.http.routers.gitea.middlewares=gitea-stripprefix"

  autoscaler:
    image: eluki/swarm-service-autoscaler:latest
    environment:
      - AUTOSCALER_DNSNAME=tasks.autoscaler
      - AUTOSCALER_INTERVAL=60  # in seconds
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    deploy:
      mode: global
      resources:
        limits:
          cpus: '1.0'
          memory: 100M
    logging:
      driver: "json-file"
      options:
        max-size: "3m"
        max-file: "3"



  nginx:
    image: nginx:alpine
    container_name: nginx-gitea
    ports:
      - "85:80"
    configs:
      - source: nginx_config
        target: /etc/nginx/nginx.conf
    networks:
      - gitea_network 


# traefik:
  #  image: traefik:v3
       
#restart: always
   # container_name: "traefik"
    #command:
     #- "--api.insecure=true"
     #- "--providers.docker=true"
     # - "--entrypoints.web.address=:85"
     # - "--entrypoints.traefik.address=:8081"
     # - "--api.dashboard=true"
     # - "--providers.docker.exposedbydefault=true"
     # - "--accesslog=true"
    #ports:
     # - "85:85"
     # - "8081:8081"
    #volumes:
     # - "/var/run/docker.sock:/var/run/docker.sock"
    #networks:
     # - gitea_network
    #deploy:
     # replicas: 1
      #placement:
       # constraints:
        #  - node.role == manager
    #labels:
     # - "traefik.enable=true"
configs:
  nginx_config:
    file: ./nginx.conf
volumes:
  gitea_data:
  gitea_config:

networks:
  gitea_network:
    driver: overlay
